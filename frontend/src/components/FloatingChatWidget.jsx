import React,{useEffect,useRef,useState}from'react';
const FALLBACK='Por ahora solo puedo responder sobre la informaciÃ³n disponible en esta pÃ¡gina ğŸ˜Š';
const SW=new Set(['el','la','los','las','un','una','lo','de','del','al','y','o','en','con','por','para','a','que','como','se','es','son','no','si','ya','su','sus','mas','mÃ¡s','tambien','tambiÃ©n','muy']);
const AL={empleo:['empleos','trabajo','laboral'],sociedad:['social','comunidad'],sesgo:['equidad','justicia','discriminacion','discriminaciÃ³n'],privacidad:['datos','personales'],transparencia:['explicabilidad','explicable'],vigilancia:['control','facial'],desinformacion:['deepfakes','sintetico','sintÃ©tico']};
const norm=t=>t?t.toLowerCase().normalize('NFD').replace(/\p{Diacritic}+/gu,'').replace(/\s+/g,' ').trim():'';
const tok=t=>norm(t).split(/[^\p{L}\p{N}]+/u).filter(w=>w&&w.length>=3&&!SW.has(w));
const split=t=>t.split(/(?<=[\.\!\?])\s+|\n+/g).map(s=>s.trim()).filter(Boolean);
function expand(ts){const e=new Set(ts);for(const t of ts){for(const[k,vs]of Object.entries(AL)){if(t===k||vs.includes(t)){e.add(k);vs.forEach(v=>e.add(v));}}}return[...e];}
function useDomIndex(exRef){const[sections,setSections]=useState([]);const toRef=useRef();useEffect(()=>{const build=()=>{try{const ex=exRef?.current||null;const nodes=[...document.body.querySelectorAll('section, main, article, [role="main"]')];const secs=[];for(const n of nodes){if(!n||(ex&&(ex===n||ex.contains(n))))continue;const h=n.querySelector('h1,h2,h3,h4');let heading=h?.innerText?.trim()||n.getAttribute('aria-label')||n.id||'Contenido';const text=(n.innerText||'').trim();if(!text)continue;const sentences=split(text).map(s=>({original:s,tokens:tok(s)}));secs.push({heading,text,sen:sentences});}setSections(secs);}catch(e){}};build();const mo=new MutationObserver(()=>{if(toRef.current)clearTimeout(toRef.current);toRef.current=setTimeout(build,250);});mo.observe(document.body,{childList:true,subtree:true});return()=>{if(toRef.current)clearTimeout(toRef.current);mo.disconnect();};},[]);return sections;}
function bestAnswer(q,sections){const qRaw=tok(q);if(!qRaw.length)return null;const qset=new Set(expand(qRaw));let best=null;for(const s of sections){for(const sent of s.sen){if(!sent.tokens?.length)continue;let over=0;for(const t of sent.tokens){if(qset.has(t))over++;}if(over>0){let hOver=0;const hset=new Set(tok(s.heading||''));for(const t of qset)if(hset.has(t))hOver++;const score=over+hOver*0.75+Math.min(sent.tokens.length,30)/120;if(!best||score>best.score)best={score,heading:s.heading,sent:sent.original};}}}return best;}
export default function FloatingChatWidget(){const[open,setOpen]=useState(false);const[input,setInput]=useState('');const[msgs,setMsgs]=useState([{role:'bot',text:'Â¡Hola! ğŸ‘‹ Soy tu asistente de Ã‰tica de la IA. Puedo ayudarte a explorar los temas de esta pÃ¡gina, como Sociedad, Ciencia, TecnologÃ­a y mÃ¡s. Preguntame lo que quieras ğŸ˜Š.'}]);const rootRef=useRef(null);const sections=useDomIndex(rootRef);const listRef=useRef(null);useEffect(()=>{if(listRef.current)listRef.current.scrollTop=listRef.current.scrollHeight;},[msgs,open]);const send=e=>{e?.preventDefault?.();const q=input.trim();if(!q)return;setInput('');setMsgs(p=>[...p,{role:'user',text:q}]);setTimeout(()=>{const b=bestAnswer(q,sections);if(!b){setMsgs(p=>[...p,{role:'bot',text:FALLBACK}]);return;}const sn=b.sent.length>280?b.sent.slice(0,277)+'â€¦':b.sent;const hl=b.heading&&b.heading!=='Contenido'?`En la secciÃ³n â€œ${b.heading}â€ se menciona: `:'En esta pÃ¡gina se menciona: ';const ans=`${hl}${sn} Â¿QuerÃ©s que te cuente mÃ¡s? ğŸ™‚`;setMsgs(p=>[...p,{role:'bot',text:ans}]);},60);};const onKey=e=>{if(e.key==='Enter'&&!e.shiftKey)send(e);};return(<div ref={rootRef} className="fixed z-[2000] bottom-4 right-4 select-none" aria-live="polite">{!open&&(<button type="button" onClick={()=>setOpen(true)} className="h-14 w-14 rounded-full bg-slate-800 text-white shadow-xl hover:scale-105 active:scale-95 transition-transform grid place-items-center border border-slate-700" aria-label="Abrir chat"><span className="text-xl" role="img" aria-label="chat">ğŸ’¬</span></button>)}{open&&(<div className="w-[86vw] max-w-[380px] md:max-w-[420px] max-h-[75vh] bg-slate-900/95 backdrop-blur rounded-2xl shadow-2xl border border-slate-700 overflow-hidden" style={{boxShadow:'0 10px 30px rgba(2,6,23,0.45)'}}><div className="bg-slate-800/95 text-white px-4 py-3 flex items-center justify-between"><div><h3 className="font-serif font-semibold">Asistente Ã‰tica de IA ğŸ¤–</h3><p className="text-xs text-slate-300">Respondo con base en esta pÃ¡gina</p></div><button type="button" onClick={()=>setOpen(false)} className="px-2 py-1 text-slate-200 hover:text-white rounded-md hover:bg-slate-700 transition-colors" aria-label="Cerrar chat">âœ•</button></div><div ref={listRef} className="p-3 space-y-3 overflow-y-auto" style={{maxHeight:'55vh'}}>{msgs.map((m,i)=>(<div key={i} className={`flex ${m.role==='user'?'justify-end':'justify-start'}`}><div className={`px-3 py-2 rounded-2xl text-sm leading-relaxed shadow ${m.role==='user'?'bg-slate-700 text-white rounded-br-sm':'bg-slate-800 text-slate-100 rounded-bl-sm'}`} style={{maxWidth:'85%'}}>{m.text}</div></div>))}</div><form onSubmit={send} className="border-t border-slate-700 bg-slate-900/80 p-2 flex items-center gap-2"><input type="text" value={input} onChange={e=>setInput(e.target.value)} onKeyDown={onKey} placeholder="EscribÃ­ tu preguntaâ€¦" className="flex-1 bg-slate-800 text-slate-100 placeholder-slate-400 text-sm px-3 py-2 rounded-xl outline-none focus:ring-2 focus:ring-slate-600 focus:bg-slate-800/90 border border-slate-700" aria-label="Ingresar pregunta"/><button type="submit" className="bg-slate-700 hover:bg-slate-600 text-white text-sm px-3 py-2 rounded-xl border border-slate-600 transition-colors">Enviar</button></form></div>)}</div>);}
